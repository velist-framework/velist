# EISK Stack - Claude Code Guidelines

## Quick Reference

```bash
# Commands
bun run dev          # Dev server (backend + frontend)
bun run build        # Production build
bun run db:migrate   # Run migrations
bun run db:generate  # Generate Drizzle migrations
bun run test:e2e     # Playwright tests

# Key Files
src/bootstrap.ts                    # App entry
src/inertia/plugin.ts               # Custom Inertia adapter
src/features/_core/database/connection.ts  # DB schema & connection
src/shared/lib/uuid.ts              # UUID v7 generator
```

## When Creating Features

### Step 1: Repository
```typescript
// src/features/[name]/repository.ts
import { db } from '../_core/database/connection'
import { uuidv7 } from '../../shared/lib/uuid'

export class FeatureRepository {
  async findAll() {
    return db.selectFrom('table_name').selectAll().execute()
  }
  
  async findById(id: string) {
    return db.selectFrom('table_name')
      .where('id', '=', id)
      .selectAll()
      .executeTakeFirst()
  }
  
  async create(data: any) {
    const id = uuidv7()
    return db.insertInto('table_name')
      .values({ id, ...data, created_at: new Date().toISOString() })
      .returningAll()
      .executeTakeFirst()
  }
  
  async update(id: string, data: any) {
    return db.updateTable('table_name')
      .set({ ...data, updated_at: new Date().toISOString() })
      .where('id', '=', id)
      .returningAll()
      .executeTakeFirst()
  }
  
  async delete(id: string) {
    return db.deleteFrom('table_name')
      .where('id', '=', id)
      .execute()
  }
}
```

### Step 2: Service with TypeBox
```typescript
// src/features/[name]/service.ts
import { t, type Static } from 'elysia'
import { FeatureRepository } from './repository'

export const CreateSchema = t.Object({
  name: t.String({ minLength: 1, maxLength: 255 }),
  description: t.Optional(t.String({ maxLength: 1000 }))
}, { additionalProperties: false })

export const UpdateSchema = t.Partial(CreateSchema)

export type CreatePayload = Static<typeof CreateSchema>
export type UpdatePayload = Static<typeof UpdateSchema>

export class FeatureService {
  constructor(private repo: FeatureRepository = new FeatureRepository()) {}
  
  getAll() { return this.repo.findAll() }
  getById(id: string) { return this.repo.findById(id) }
  create(data: CreatePayload) { return this.repo.create(data) }
  update(id: string, data: UpdatePayload) { return this.repo.update(id, data) }
  delete(id: string) { return this.repo.delete(id) }
}
```

### Step 3: API Routes
```typescript
// src/features/[name]/api.ts
import { Elysia } from 'elysia'
import { inertia, type Inertia } from '../../inertia/plugin'
import { FeatureService, CreateSchema, UpdateSchema } from './service'

export const featureApi = new Elysia({ prefix: '/features' })
  .use(inertia())
  .derive(() => ({ service: new FeatureService() }))
  
  // List
  .get('/', async (ctx) => {
    const { inertia, service } = ctx as typeof ctx & { inertia: Inertia }
    const items = await service.getAll()
    return inertia.render('feature/Index', { items })
  })
  
  // Create form
  .get('/create', (ctx) => {
    const { inertia } = ctx as typeof ctx & { inertia: Inertia }
    return inertia.render('feature/Create', { errors: {} })
  })
  
  // Store
  .post('/', async (ctx) => {
    const { body, service, inertia } = ctx as typeof ctx & { inertia: Inertia }
    try {
      await service.create(body)
      return inertia.redirect('/features')
    } catch (error: any) {
      return inertia.render('feature/Create', { 
        errors: { name: error.message } 
      })
    }
  }, { body: CreateSchema })
  
  // Edit form
  .get('/:id/edit', async (ctx) => {
    const { params, service, inertia } = ctx as typeof ctx & { inertia: Inertia }
    const item = await service.getById(params.id)
    if (!item) return inertia.render('errors/404', { path: ctx.request.url })
    return inertia.render('feature/Edit', { item, errors: {} })
  })
  
  // Update
  .put('/:id', async (ctx) => {
    const { params, body, service, inertia } = ctx as typeof ctx & { inertia: Inertia }
    try {
      await service.update(params.id, body)
      return inertia.redirect('/features')
    } catch (error: any) {
      const item = await service.getById(params.id)
      return inertia.render('feature/Edit', { 
        item, 
        errors: { name: error.message } 
      })
    }
  }, { body: UpdateSchema })
  
  // Delete
  .delete('/:id', async (ctx) => {
    const { params, service, inertia } = ctx as typeof ctx & { inertia: Inertia }
    await service.delete(params.id)
    return inertia.redirect('/features')
  })
```

### Step 4: Svelte Pages

**Index.svelte:**
```svelte
<script lang="ts">
  import { useForm } from '@inertiajs/svelte'
  import { Plus, Pencil, Trash } from 'lucide-svelte'
  
  interface Props {
    items: Array<{ id: string; name: string; description?: string }>
  }
  
  let { items }: Props = $props()
  
  const deleteForm = useForm({})
  
  function destroy(id: string) {
    if (confirm('Delete this item?')) {
      $deleteForm.delete(`/features/${id}`)
    }
  }
</script>

<div class="p-6 max-w-4xl mx-auto">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Features</h1>
    <a href="/features/create" class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
      <Plus class="w-4 h-4" />
      Create New
    </a>
  </div>
  
  <div class="bg-white dark:bg-slate-800 rounded-lg shadow overflow-hidden">
    {#each items as item}
      <div class="flex justify-between items-center p-4 border-b border-slate-200 dark:border-slate-700 last:border-0">
        <div>
          <h3 class="font-medium text-slate-900 dark:text-white">{item.name}</h3>
          {#if item.description}
            <p class="text-sm text-slate-500 dark:text-slate-400">{item.description}</p>
          {/if}
        </div>
        <div class="flex gap-2">
          <a href="/features/{item.id}/edit" class="p-2 text-slate-600 hover:text-indigo-600 dark:text-slate-400 dark:hover:text-indigo-400">
            <Pencil class="w-4 h-4" />
          </a>
          <button onclick={() => destroy(item.id)} class="p-2 text-slate-600 hover:text-red-600 dark:text-slate-400 dark:hover:text-red-400">
            <Trash class="w-4 h-4" />
          </button>
        </div>
      </div>
    {/each}
    
    {#if items.length === 0}
      <div class="p-8 text-center text-slate-500 dark:text-slate-400">
        No items found. Create your first one!
      </div>
    {/if}
  </div>
</div>
```

**Create.svelte:**
```svelte
<script lang="ts">
  import { useForm } from '@inertiajs/svelte'
  import { ArrowLeft } from 'lucide-svelte'
  
  interface Props {
    errors: Record<string, string>
  }
  
  let { errors }: Props = $props()
  
  const form = useForm({
    name: '',
    description: ''
  })
  
  function submit(e: Event) {
    e.preventDefault()
    $form.post('/features')
  }
</script>

<div class="p-6 max-w-2xl mx-auto">
  <div class="flex items-center gap-4 mb-6">
    <a href="/features" class="p-2 text-slate-600 hover:text-slate-900 dark:text-slate-400 dark:hover:text-white">
      <ArrowLeft class="w-5 h-5" />
    </a>
    <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Create Feature</h1>
  </div>
  
  <form onsubmit={submit} class="bg-white dark:bg-slate-800 rounded-lg shadow p-6 space-y-4">
    <div>
      <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Name</label>
      <input 
        type="text" 
        bind:value={$form.name}
        class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white"
        required
      />
      {#if errors.name}
        <p class="mt-1 text-sm text-red-600">{errors.name}</p>
      {/if}
    </div>
    
    <div>
      <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Description</label>
      <textarea 
        bind:value={$form.description}
        rows="3"
        class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white"
      ></textarea>
    </div>
    
    <div class="flex justify-end gap-3 pt-4">
      <a href="/features" class="px-4 py-2 text-slate-700 dark:text-slate-300 hover:text-slate-900">
        Cancel
      </a>
      <button 
        type="submit" 
        disabled={$form.processing}
        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50"
      >
        {$form.processing ? 'Creating...' : 'Create'}
      </button>
    </div>
  </form>
</div>
```

**Edit.svelte:**
```svelte
<script lang="ts">
  import { useForm } from '@inertiajs/svelte'
  import { ArrowLeft } from 'lucide-svelte'
  
  interface Props {
    item: { id: string; name: string; description?: string }
    errors: Record<string, string>
  }
  
  let { item, errors }: Props = $props()
  
  const form = useForm({
    name: item.name,
    description: item.description || ''
  })
  
  function submit(e: Event) {
    e.preventDefault()
    $form.put(`/features/${item.id}`)
  }
</script>

<div class="p-6 max-w-2xl mx-auto">
  <div class="flex items-center gap-4 mb-6">
    <a href="/features" class="p-2 text-slate-600 hover:text-slate-900 dark:text-slate-400 dark:hover:text-white">
      <ArrowLeft class="w-5 h-5" />
    </a>
    <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Edit Feature</h1>
  </div>
  
  <form onsubmit={submit} class="bg-white dark:bg-slate-800 rounded-lg shadow p-6 space-y-4">
    <div>
      <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Name</label>
      <input 
        type="text" 
        bind:value={$form.name}
        class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white"
        required
      />
      {#if errors.name}
        <p class="mt-1 text-sm text-red-600">{errors.name}</p>
      {/if}
    </div>
    
    <div>
      <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Description</label>
      <textarea 
        bind:value={$form.description}
        rows="3"
        class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white"
      ></textarea>
    </div>
    
    <div class="flex justify-end gap-3 pt-4">
      <a href="/features" class="px-4 py-2 text-slate-700 dark:text-slate-300 hover:text-slate-900">
        Cancel
      </a>
      <button 
        type="submit" 
        disabled={$form.processing}
        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50"
      >
        {$form.processing ? 'Saving...' : 'Save Changes'}
      </button>
    </div>
  </form>
</div>
```

### Step 5: Mount & Migrate
```typescript
// src/bootstrap.ts
import { featureApi } from './features/[name]/api'

app.use(featureApi)
```

Then run:
```bash
bun run db:generate  # If new table
bun run db:migrate
```

## Critical Reminders

1. **UUID v7 only** - Never use auto-increment IDs
2. **TypeBox for everything** - Both validation and TypeScript types
3. **Inline Tailwind** - No Button.svelte components
4. **Snake_case DB** - `created_at`, not `createdAt`
5. **ISO timestamps** - `new Date().toISOString()`
6. **Bun APIs** - Use `Bun.password`, `Bun.file`, etc.

## Anti-Patterns to Avoid

```typescript
// ❌ Don't use horizontal layers
src/controllers/user.ts
src/models/user.ts
src/views/user.svelte

// ❌ Don't use external uuid libraries
import { v4 } from 'uuid'  // Wrong!

// ❌ Don't use Date objects for DB
created_at: new Date()  // Wrong! Use .toISOString()

// ❌ Don't create component abstractions
<!-- Button.svelte -->  <!-- Don't do this -->

// ❌ Don't use npm/node
npm install  # Wrong! Use bun install
```
